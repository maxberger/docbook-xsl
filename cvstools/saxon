#!/bin/bash

# This shell script will definitely need to be hacked to run on your system!
# This script is usually called by the xslt script.
#
# Usage: saxon [shellopts] src.xml style.xsl output.{xml|html} [styleopts]
#

DONE=0
VERSION=652
EXTVERSION=643
DEBUG=0
XARG=""
YARG=""
RARG=""
MEMORY=""
QUIET=0


MYDIR=`dirname $0`
. $MYDIR/common-functions.sh

# identify the directory for DocBook XSL
for dir in "/sourceforge/docbook/xsl" \
           "$MYDIR/xsl" \
           "/usr/share/sgml/docbook/stylesheet/xsl/nwalsh" ; do
  if [ -d "$dir" ]; then
    DOCBOOKXSL="$dir"
    break
  fi
done

while [ "$DONE" = "0" ]; do
    case $1 in
	-d)	DEBUG=1;
		shift;
		;;
	-652)	VERSION=652;
		shift;
		;;
	-651)	VERSION=651;
		shift;
		;;
	-65)	VERSION=65;
		shift;
		;;
	-644)	VERSION=644;
		shift;
		;;
	-643)	VERSION=643;
		shift;
		;;
	-x)     shift;
		XARG="-x $1";
		shift;
		;;
	-y)     shift;
		YARG="-y $1";
		shift;
		;;
	-r)     shift;
		RARG="-r $1";
		shift;
		;;
        -m)     shift
		MEMORY="-Xmx$1";
		shift;
		;;
        -q)     shift
		QUIET=1
		;;
        -X)     shift
		DOCBOOKXSL="$1";
		shift;
		;;
	-*)	DONE=1;
		echo "unexpected argument: $*" 1>&2
		exit 1
		;;
	*)	DONE=1
    esac
done

XMLSRC=$1; shift
XMLSTY=$1; shift
OUTPUT=$1; shift

if [ "$OUTPUT" = "-" ]; then
    OUTPUT="";
fi

if [ "$OUTPUT" != "" ]; then
  OUTPUT="-o $OUTPUT"
fi

if [ ! -d "$DOCBOOKXSL" ]; then
  echo "DocBook XSL dir '$DOCBOOKXSL' doesn't exist" 1>&2
  echo "  Try using the '-X <dir>' argument" 1>&2
  exit 1
fi

case $VERSION in
   652|651|65|644|643)
        :                       # handled normally below
	;;
    *)	echo "unexpected Saxon version $VERSION" 1>&2
	exit 1
	;;
esac


DOTTEDVERSION=`echo $VERSION | sed -e 's/\([0-9]\)\([0-9]\)/\1.\2/g;' | sed -e 's/\([0-9]\)\([0-9]\)/\1.\2/g;'`

##
## locate saxon.jar
##
for jar in "/usr/local/java/saxon-$DOTTEDVERSION/saxon.jar" \
           "/usr/local/share/java/saxon-$DOTTEDVERSION/saxon.jar" \
           "/usr/share/java/saxon-$DOTTEDVERSION.jar" \
           "/usr/local/java/saxon/saxon.jar" \
           "/usr/local/share/java/saxon/saxon.jar" \
           "/usr/share/java/saxon.jar"; do
  if [ -f "$jar" ]; then
    SAXON="$jar"
    break
  fi
done
if [ ! -f "$SAXON" ]; then
  echo "warning: cannot locate Saxon JAR file" 1>&2
fi

##
## DocBook extensions
##
if [ ! "$NDWEXT" ]; then
  for ext in "$DOCBOOKXSL/extensions/saxon$EXTVERSION/.classes" \
             "$DOCBOOKXSL/extensions/saxon$EXTVERSION.jar" \
             "/usr/share/sgml/docbook/stylesheet/xsl/nwalsh/extensions/saxon$EXTVERSION.jar" ; do
    if [ -d $ext -o -f $ext ]; then
      NDWEXT=$ext;
      break
    fi
  done
  if [ ! "$NDWEXT" ]; then
    echo "warning: cannot locate DocBook XSL Saxon extensions" 1>&2
  fi
fi

##
## Saxon debugging stuff
##
if [ "$DEBUG" = "1" ]; then
  for try in "/usr/local/java/saxon-$DOTTEDVERSION/.classes" \
             "/usr/local/share/java/saxon-$DOTTEDVERSION/.classes" \
             "/usr/share/java/saxon-$DOTTEDVERSION/.classes"; do
    if [ -d "$try" ]; then
        SAXON="$try:$SAXON"
    fi
  done
fi

##
## locate Xerces classpath
##
XERCES=`findxerces`
if [ ! "$XERCES" ]; then
  echo "warning: cannot locate Xerces (xerces.jar)" 1>&2
fi


##
## locate JAXP classpath
##
JAXP=`findjaxp`
if [ ! "$JAXP" ]; then
  echo "warning: cannot locate JAXP (jaxp.jar)" 1>&2
fi

##
## optionally replace the URI resolver with the Apache
## resolver classes
##
for path in $RESOLVER \
	    "/projects/apache/xml-commons/java/build/classes" ; do
  if [ -f "$path" -o -d "$path" ]; then
    RESOLVER="$path"
    break
  fi
done
if [ -f "$RESOLVER" -o -d "$RESOLVER" ]; then
  # use the apache resolver
  if [ ! "$XARG" ]; then
    XARG="-x org.apache.xml.resolver.tools.ResolvingXMLReader"
  fi
  if [ ! "$YARG" ]; then
    YARG="-y org.apache.xml.resolver.tools.ResolvingXMLReader"
  fi
  if [ ! "$RARG" ]; then
    RARG="-r org.apache.xml.resolver.tools.CatalogResolver"
  fi
fi

CLASSPATH=$SAXON:$NDWEXT:$JAXP:$RESOLVER:$XERCES:$CLASSPATH

# echo "classpath is $CLASSPATH"

if [ "$QUIET" = "0" ]; then
  echo saxon$VERSION $OUTPUT $XMLSRC $XMLSTY "$@"

  if [ "$MEMORY" != "" ]; then
      echo "java $MEMORY ..."
  fi
fi

TRANSFACTORY=com.icl.saxon.TransformerFactoryImpl

# Force Saxon to use a decent parser (AElfred doesn't do PEs right)
DBFACTORY=org.apache.xerces.jaxp.DocumentBuilderFactoryImpl
SPFACTORY=org.apache.xerces.jaxp.SAXParserFactoryImpl

exec java $MEMORY $FOO \
     -cp $CLASSPATH \
     -Djavax.xml.parsers.DocumentBuilderFactory=$DBFACTORY \
     -Djavax.xml.parsers.SAXParserFactory=$SPFACTORY \
     -Djavax.xml.transform.TransformerFactory=$TRANSFACTORY \
     com.icl.saxon.StyleSheet \
     $XARG $YARG $RARG $OUTPUT $XMLSRC $XMLSTY "$@"
